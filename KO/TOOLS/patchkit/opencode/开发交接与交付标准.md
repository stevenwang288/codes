# PatchKit（OpenCode 命令包）开发交接与交付标准

> 位置：`code-main/tools/opencode-patchkit/`
>
> 目标：把 PatchKit 作为一个“命令包/技能包”长期演进。
> - 面向使用者：在 OpenCode 里通过 `/` 斜杠命令触发工作流；也可用 PowerShell 脚本直接跑。
> - 面向维护者：有清晰的目录规范、产物规范、验收标准与排障指南。

---

## 1. 你要做的是什么（概念澄清）

你描述的需求我理解为三层：

1) **补丁层（Patch）**：对 opencode 上游做本地定制（可重复应用）
   - 例如：强制中文、禁 Claude 注入、会话恢复策略、TUI 防误退等。

2) **命令层（Command Pack）**：把这些能力“产品化”为可调用命令
   - 最好是在 OpenCode 内用 `/xxx` 触发，保持在同一界面内操作。
   - 但不强求全自动：每一步执行完提示是否继续（向导式）。

3) **自动收集/国际化层（i18n Pipeline）**：
   - 先收集：统计有哪些“待处理/待汉化”的文案
   - 再处理：由“正常交互的 AI”做高质量中文润色（软件/计算机/AI/网络行业语境）
   - 再交付：编译/打包/重启，让新版本生效

PatchKit 的定位：**把 1+2 做扎实，再逐步把 3 体系化**。

---

## 2. 目录结构规范（必须遵守）

```
tools/opencode-patchkit/
  README.md
  patchkit.json.example
  开发交接与交付标准.md     # <= 本文档（必须长期维护）
  scripts/
    _lib.ps1
    run.ps1
    start.ps1
    run-all.ps1
    wizard.ps1
    i18n-stats.ps1
    install-global.ps1
    cleanup-legacy.ps1
  templates/
    AGENTS.md
  patches/
    opencode-open-code.patch
  .state/
    build-stamps.json
```

### 2.1 目录职责

- `scripts/`：所有“可执行入口”与可复用逻辑（PowerShell）。
- `templates/`：注入到用户配置目录的模板（例如全局 AGENTS）。
- `patches/`：只用于“人工审阅/变更说明”。真正权威是脚本。
- `.state/`：PatchKit 自己的状态（用于跳过重复编译等）。

---

## 3. PatchKit 产物（Artifacts）规范

### 3.1 产物清单

1) **全局规则**（用于让行为稳定、中文稳定）
   - 目标：`~/.config/opencode/AGENTS.md`
   - 来源：`tools/opencode-patchkit/templates/AGENTS.md`

2) **全局启动命令**（Windows）
   - 目标：安装后必须同时可用：`op` / `OP` / `opencode`
   - 由 `scripts/install-global.ps1` 生成：
     - `op.ps1`, `op.cmd`, `OP.cmd`, `opencode.cmd`
   - 注入 env：
     - `OPENCODE_DISABLE_CLAUDE_CODE=1`
     - `OPENCODE_LANGUAGE=zh-CN`

3) **状态文件**
   - `tools/opencode-patchkit/.state/build-stamps.json`
   - 用于判断是否需要重新 build（避免每次启动都慢）。

4) **插件缓存**（OpenCode 自身维护）
   - `~/.cache/opencode/node_modules`
   - 注意：这里的 registry/网络状况会显著影响启动速度。

---

## 4. 命令包（Slash Commands）规范

### 4.1 为什么用 `/` 命令

OpenCode 支持在 `~/.config/opencode/commands/` 放 markdown，自定义命令。
这正好可以把 PatchKit 的“工作流步骤”变成可调用命令。

注意：

- `/` 命令本质是“给 agent 一段模板 prompt”，不是一个纯脚本。
- 有副作用的步骤（git pull / build / 改配置）必须由 agent 使用 bash 工具执行，并在每一步后询问是否继续。

### 4.2 命令设计原则

1) **单一职责**：每个命令做一件事（统计/更新/打补丁/编译/重启提示）。
2) **可组合**：提供一个 `wizard` 命令串联多个步骤，逐步确认。
3) **可移植**：命令不要写死机器路径；若必须写死（如本机 D:/...），需要明确写在文档并提供参数化替代。
4) **不破坏代码**：命令输出/翻译遵循“URL/路径/代码不翻译”的硬约束。

### 4.3 已提供的命令（当前状态）

- `~/.config/opencode/commands/patchkit-stats.md`
  - 汇总版本/插件缓存/i18n 待处理数
- `~/.config/opencode/commands/patchkit-wizard.md`
  - 描述向导步骤（强调必须由 agent 分步执行）

后续建议新增（按优先级）：

1) `/patchkit-update <RepoRoot>`：检查是否落后 origin/dev，提示是否 pull
2) `/patchkit-apply <RepoRoot>`：运行 PatchKit 打补丁
3) `/patchkit-i18n <RepoRoot>`：统计 pending
4) `/patchkit-build <RepoRoot>`：触发智能 build
5) `/patchkit-restart`：只输出“如何用 op/OP/opencode 重启”的操作提示

---

## 5. 自动收集/国际化（只做简体中文）规范

### 5.1 目标边界

- 只输出简体中文 `zh-CN`
- 翻译/润色由“正常交互 AI”来做（人工确认、行业语境更准）
- 自动化只做：
  - 统计待处理数量
  - 生成/回写 `zh-CN` 的 locale 骨架（只填空，不覆盖已有翻译）

### 5.2 不可破坏规则（必须）

不得翻译/改写：

- URL/域名/IP/端口/querystring
- 本地路径（Windows `C:\...` / POSIX `/usr/...`）、文件名、扩展名
- 代码片段、命令行、环境变量、配置 key、JSON key（只翻译 value）

术语建议保留：API、SDK、CLI、TUI、MCP、JSON、HTTP、WebSocket、token、prompt、agent、worktree。

### 5.3 多技术栈“智能判断”方向（下一阶段）

你希望“收集功能能兼容很多技术栈（Rust/TS/…）并智能判断用哪种方式”。

建议的最小可行策略（按 project 目录判别）：

1) **JS/TS 前端/Node 项目**：
   - 优先运行期收集（missing keys）+ 静态扫描（AST/TS）
2) **Rust 项目**：
   - 静态收集为主（例如扫描 `t!("key")`、`tr!(...)`、`format!(...)` 等约定）
3) **混合仓库（monorepo）**：
   - 按子目录类型分别收集，再统一汇总

交付时“智能判断”的最小落点：

- 检测文件：`package.json` / `Cargo.toml` / `go.mod` / `pyproject.toml`
- 根据命中优先级选择 collector
- 产出统一 JSON：`{ "zh-CN": { "key": "source" } }`

---

## 6. 验收标准（必须可验证）

### 6.1 PatchKit 自身

1) `tools/opencode-patchkit/scripts/start.ps1` 可在配置 RepoRoot 后一键执行
2) 智能 build 生效：无变更时不会重复 `bun run build`
3) `install-global.ps1` 安装后 `op`/`OP`/`opencode` 都可用
4) `wizard.ps1` 每步执行后都会询问是否继续
5) 文档存在且可指导新同学继续维护（本文档）

### 6.2 OpenCode 行为体验

1) 简体中文稳定（不依赖系统 locale）
2) 禁 Claude 注入（不加载 `~/.claude`）
3) Ctrl+C 三连按退出
4) 非 git 目录不会串会话
5) Home 的“继续上次会话？”提示出现足够早且只匹配 cwd

---

## 7. 排障（常见问题快速定位）

### 7.1 插件安装 404 / tag 不存在

症状：启动慢或报错 `GET https://registry... 404` / `tag latest not found`。

处理：

- 优先把这些插件改为“本地 wrapper（file://）”
- 或在 `opencode.json.plugin` 中移除不可用插件
- 固定 registry：`~/.cache/opencode/.npmrc` 设为 `registry=https://registry.npmjs.org/`

### 7.2 需要“面板/快捷键”展开 PatchKit 功能

现状：OpenCode 自带 Command Palette（Ctrl+P）和 `/commands`。

最小可交付路径：

- 先用 `/patchkit-*` 命令组合达到“同一界面内调用”的体验

下一阶段：

- 评估是否需要在 opencode TUI 内新增一个 PatchKit 面板（这通常需要改 opencode TUI 源码，不建议一上来就做）。

---

## 8. 维护建议（原则）

1) KISS：先把“命令包 + 向导”打磨到稳定。
2) 幂等优先：脚本改文件必须可重复执行。
3) 风险可控：git pull/build 等有副作用动作必须询问。
4) 逐步演进：先覆盖主 opencode（TUI/Web/App）再扩多技术栈。

