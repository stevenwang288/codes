# CODES 总需求 Todo（汇总版）

> 目标：把当前 fork 打造成独立产品 **CODES**（命令 `codes`、数据目录 `~/.codes`），并通过“补丁化/脚本化”方式可持续跟进上游更新。
>
> 说明：本文件只做需求与方案收敛；真正开发按优先级逐条落地，并为关键交互补回归测试。

---

## 已完成（Patch 记录）

- ✅ `codes` 可执行（替代 `code`）与 Windows/macOS/Linux 安装脚本已落地（`scripts/install-codes.ps1` / `scripts/install-codes.sh`）。
- ✅ `./build-fast.sh` 已适配 `codes` 产物，Windows `.exe` 产物拷贝链路已验证可运行（`codes --version`）。
- ✅ Windows `codes.cmd` 参数透传已修复：`--help` / `--version` 不再被 PowerShell 误解析为脚本参数。
- ✅ `codes doctor` 已改为围绕 `codes` 做 PATH/版本诊断，并避免管道提前关闭导致崩溃（broken pipe）。
- ✅ CODES 独立化方向已明确并落盘：不共享 `~/.codex` / `~/.code`（见 `docs/交接文档.md`）。
- ✅ `/settings` overlay 的 `Esc` 逐级返回已补齐一条关键链路，并已补回归测试（尚未全量覆盖所有面板/弹窗）。
- ✅ `Ctrl+L`（模式面板）底部固定显示“当前项目路径”，空间不足时左侧省略显示尾部。

## P0（必须先稳定体验）

### 1) 交互一致性：Esc 逐级返回（统一规则）
- **规则**：任何弹窗/面板/子菜单里按 `Esc` 都只“退一级”，一直退到聊天主界面后不再继续退出/干扰。
- **适用范围**：`Ctrl+A / Ctrl+G / Ctrl+L` 面板、`/settings` 全屏设置、所有设置子页、所有 picker、所有 bottom pane view。
- **验收**：
  - 任意层级：`Esc` 必然可预测地回退，不会“突然直接关闭整个面板”或“跳层”。
  - 为关键入口补测试：至少覆盖 settings 的 `Content → Sidebar → Menu → Close` 链路。

### 2) 统一产品命名与用户可见文案（全局 CODES）
- **目标**：用户界面与用户文档不再出现 `Code`/`Codex`/`Every Code` 等历史命名；统一为 `CODES`/`codes`。
- **范围**：
  - TUI/CLI 所有提示、报错、引导文案（含登录提示、配置路径提示）
  - 发行与安装文档（README 与 CODES 权威文档）
- **额外约束**：UI 不出现 `*_HOME` / `HOME` 字样（例如 `CODES_HOME`）。
- **验收**：常见路径（启动、登录失败、配置缺失、权限不足）触发的提示均符合命名与文案约束。

### 3) “最高权限/最顺滑”运行模式（减少阻塞与弹窗）
- **目标**：用户明确选择“最高权限”后，尽量减少审批/确认阻塞，保证长任务不中断。
- **需要排查/改造点**：
  - `approval_policy` / `sandbox_mode` 的组合（包含 TUI 与 CLI 两条入口）。
  - `confirm_guard`（即使 `approval_policy=never`，仍可能要求显式确认前缀）。
  - 任何“提示/警告”是否会阻塞 Auto Drive 或多代理流程（只提示不阻塞）。
- **产出**：
  - 新增一个“Power/最高权限”预设（建议放入 `Ctrl+L` 面板 + `/settings`），一键应用：
    - `sandbox_mode = "danger-full-access"`
    - `approval_policy = "never"`
    - `confirm_guard.patterns = []`（或提供“完全关闭 confirm_guard”的开关）
  - 文档：解释为什么“最高权限”仍可能被 `confirm_guard` 影响，以及如何关闭。

### 4) 长任务（5–10 小时）工程化策略
- **目标**：在“权限已对齐 + TODO 足够清晰”的情况下，让任务持续推进、可恢复、可观测。
- **方向**：
  - 会话持久化与断点恢复（避免一次 crash/断电导致上下文全丢）。
  - 自动压缩/回放策略（控制上下文膨胀）。
  - 子代理隔离主上下文污染（主编排只拿摘要/进度）。
- **验收**：
  - 运行 2h+ 不需要频繁人工干预（除非确实需要输入/审批）。
  - 发生卡住可被监测并恢复（见 P1 的“子代理监控”）。

### 5) 少提问/不绕圈（交互与提示词/机制约束）
- **目标**：用户给简单需求时，CODES 不“先问一堆再开始”，而是默认主动收集信息与推进。
- **规则**：
  - 默认先读：项目根 `README`、`docs/`、目录树、关键配置与入口文件。
  - 只问关键分歧：仅在不可逆/高风险/存在多种同等合理路线时提问。
  - 不重复确认：已明确的硬约束不再重复问“是否确定”。
- **验收**：在“了解项目/读文档/简单改动”类请求上，问句数量显著下降且不影响准确性。

---

## P1（效率与可观测性）

### 6) 子代理监控与“卡住”判定
- **目标**：子代理容易卡住，需要在 UI 中“像下载进度一样”可视化，并在 30/60/90 秒无增量时提醒/介入。
- **设计点**：
  - 为每个子代理维护：`last_progress_at`、`last_output_digest`、`phase`、`retry_count`。
  - UI：顶部/侧栏显示进度条/阶段条，支持一键“暂停/终止/接管编辑”。
  - 策略：无增量 N 秒 → 主编排发起“健康检查”或“切换模型/降并发/重新分解”。

### 7) 多标签/后台友好：桌面通知 + 声音提醒
- **目标**：你在多个终端标签页/窗口工作时，关键事件可被系统通知与声音提示捕获。
- **建议默认触发**：
  - 回合完成（turn complete）
  - 需要你介入（approval/input requested）
  - 可能卡住（stall detected / 无增量超时）
- **验收**：Windows/macOS/Linux 至少各有一种可用实现；无法原生实现时提供可配置的外部命令 hook 方案。

### 8) 主代理“无增量卡住”检测（长时工作模式基础能力）
- **目标**：不仅子代理会卡住，主流程也可能长时间等待；需要以“无增量”为判据给出提醒，并尽量不阻塞其它 TODO 推进。
- **设计点**：
  - 统一“进度心跳”指标：任意新事件/输出/状态变更都算增量（含工具事件、流式输出、UI 状态变更）。
  - 无增量超过阈值：UI 显示 `Stalled` 状态 + 桌面通知/声音；提供一键操作：`取消/重试/降级/改拆分/切换任务`。
  - 可配置：30/60/90/180 秒等档位；可作为“长时工作模式”的默认常态。
- **验收**：
  - 真实卡住能被及时提醒；正常长耗时操作不会被误报（例如构建/下载应有进度心跳）。

### 9) 质量档案：错误收录与复盘（跨项目复用）
- **目标**：把“跑过的坑”变成可检索资产：自动收录关键错误/失败原因/环境信息，复盘后沉淀，降低重复试错成本。
- **范围**：
  - 运行期错误：启动失败、鉴权失败、网络/代理问题、MCP 启动失败、命令执行失败、崩溃/卡住等
  - 环境信息：OS/版本、终端类型、PATH 冲突摘要、网络可达性/代理状态（只记录必要摘要，避免泄露敏感信息）
  - 用户侧补充：允许手动标注“原因/结论/规避策略”
- **实现建议**（避免上下文膨胀）：
  - 记录到 `~/.codes/diagnostics/` 的 JSONL（例如 `incidents.jsonl`），默认不注入 prompt。
  - 提供 `/diagnostics`（或 `codes diagnostics`）做摘要、筛选与导出（可导出为 Markdown “复盘报告”）。
- **验收**：
  - 能快速回答“为什么上次卡住/失败”与“以后怎么避免”。
  - 默认不把绝对路径与敏感 token 写入档案（必要信息脱敏/截断）。

### 10) “后台质量卫兵”与开发速度模式
- **诉求**：你希望“先快开发，后集中校验”，但仍要保持质量。
- **方案方向**：
  - 引入后台常驻“审计/测试子代理”（更高推理等级、更慢）：
    - 主代理继续编码；质量子代理后台拉取 diff/日志/关键文件做审计。
  - 提供“开发速度”模式开关（建议集成到 `Ctrl+L`）：
    - **Fast**：少跑检查，只做最小 smoke
    - **Balanced**：关键检查（lint/build）+ 关键测试集
    - **Strict**：全量回归（仅在要交付时启用）
  - **注意**：这些都是“策略/编排层”功能，避免在每轮交互里输出冗长说明。

### 11) 输出克制：减少路径/环境噪音
- **目标**：默认不要在聊天里频繁输出大量路径；用户需要时再问。
- **范围**：
  - Agent 输出风格（prompt 指令）
  - UI/系统提示（如环境注入展示）
  - AGENTS.md 参考模板：对齐上游/社区最佳实践（含“简练直接说事”的风格要求）
- **验收**：
  - 非必要不列路径清单；涉及路径时展示用户友好的形式（如 `~/.codes/...`），不出现 `*_HOME` 字样。

---

## P2（UX/功能增强）

### 12) “Ctrl+L 面板”作为自定义功能总入口
- **目标**：把我们新增/增强的能力集中到统一面板（类似 Windows 设置），支持“选择 → 应用/确定”。
- **候选收纳项**：
  - 权限预设（最高权限/平衡/只读）
  - 输出风格（是否展示思考过程、verbosity）
  - 子代理监控阈值（30/60/90 秒）
  - UI 行为（Esc 规则、主题、提示条等）

### 13) 路径交互：Ctrl+Click 打开本地路径（可选）
- **说明**：终端内要做到“Ctrl+鼠标单击打开路径”受终端模拟器能力影响（Warp 的能力不等于通用 TUI）。
- **方案**：
  - 如果能捕获 `MouseEvent` 且能解析命中的路径 → 调用系统 opener 打开。
  - 否则提供替代：选中后按快捷键（例如 `Ctrl+O`）打开当前光标处/选中的路径。

### 14) “选中停 1 秒自动复制” + 右上角 Toast
- **风险**：大多数终端的“文本选中”发生在终端模拟器层，TUI 进程通常收不到“选中事件”。
- **替代方案**：
  - 在 TUI 内实现可控的选择模式（鼠标拖选/键盘选区），由程序负责复制与 toast。
  - 或提供显式快捷键复制（如 `y`/`Ctrl+C` 复制当前行/块）。

### 15) 消息类型差异化底色/样式
- **目标**：按消息类型区分底色（用户/模型/工具/系统/错误/子代理）。
- **验收**：主题兼容（Ansi16/Ansi256/TrueColor）下可读性一致。

### 16) 语音输入（可选）：语音转文字 + 二次纠错/润色
- **目标**：在 CLI/TUI 内提供一键语音输入（录音→转写→（可选）纠错润色→写入 composer）。
- **方案方向**：
  - 在线：接入语音转写 API（优先），再接一层“纠错/标点/润色”的模型调用。
  - 离线：本地 Whisper（后置增强）。
- **验收**：默认关闭；开启后不影响核心功能与隐私预期；失败有明确降级提示（例如回退为手动输入）。

### 17) 固定展示“当前项目路径”（多项目多标签必需）
- **目标**：在 TUI 中始终可见当前窗口对应的项目路径（工作目录/工作根），避免多标签切换时迷失。
- **展示位置建议**（从易到难）：
  - `Ctrl+L` 面板固定区域（优先）：展示绝对路径，空间不足时只显示尾部（前缀省略号）。
  - TUI 顶部状态栏（可选）：右侧显示路径尾部；提供一个操作复制完整路径。
- **验收**：
  - 打开多个项目窗口时能一眼确认“当前是哪个项目”。
  - 不在 UI 文案中出现 `*_HOME` / `HOME` 字样。

---

## P3（补丁化体系：对齐官方上游）

### 18) “补丁包 / 脚本注入”体系（PatchKit 方向）
- **目标**：我们不直接依赖社区增强版做长期底座；最终应能：
  - 跟随 `openai/codex` 更新
  - 一键执行脚本，把我们的改造“逐条注入”
- **组成建议**：
  - `patches/`：可重放的 patch（分主题：命令与路径、i18n、TUI 交互、子代理、性能等）
  - `scripts/patchkit/`：自动应用 patch、检测冲突、输出变更报告
  - `docs/patchkit/`：每条 patch 的目的、依赖、验收用例

### 19) i18n 真·国际化（汉化作为其中一部分）
- **目标**：不是“写死中文”，而是可切换语言且覆盖 UI 关键路径。
- **验收**：
  - zh-CN 覆盖所有设置页/弹窗/关键提示
  - 新增文案必须走 i18n key（避免回归英文残留）
