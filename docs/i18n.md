# 国际化（i18n）约定

目标：在不改变任何代码逻辑的前提下，把“用户可见文案”从代码中抽离，支持 `zh-CN` / `en` 切换；缺失翻译时自动回退英文，并能持续收集缺口，便于后续补齐与跟进上游更新。

## 1) 运行时语言选择

- 默认语言：`zh-CN`
- 环境变量：
  - `CODEX_LANG=zh-CN|en`
  - 兼容：`OPENCODE_LANGUAGE=zh-CN|en`
- TUI 内：`/lang`（弹出选择菜单）或 `/lang zh-CN`、`/lang en`

## 2) 文案出口规则（底线：不改逻辑）

- 只允许改“用户可见字符串”及其输出方式；不改控制流/状态机/业务行为。
- 严格避免“过度翻译”：
  - 路径、URL、命令、flag、环境变量名（如 `PATH`、`CODEX_HOME`）保持原样。
  - 专业术语优先保留英文或中英混排（例如 `MCP`、`Bearer Token`）。
- Rust 侧建议使用：
  - `code_i18n::tr_plain("key")`：纯字符串
  - `code_i18n::tr_args(lang, "key", &[("name", value)])`：带插值（`${name}`）

语言包文件：

- `code-rs/i18n/assets/en.json`
- `code-rs/i18n/assets/zh-CN.json`

## 3) 缺失翻译采集（用于持续补齐）

当 `zh-CN` 缺 key 且回退英文时，会追加写入：

- `$CODE_HOME/i18n-missing.jsonl`（或 `$CODEX_HOME/i18n-missing.jsonl`）

每条记录包含 `missing_in/key/fallback_text` 等字段，可用于后续批量补翻译。

## 4) AST/Token 静态扫描（用于发现硬编码）

提供工具：`code-i18n-scan`（Rust AST/Token 扫描字符串字面量，给出候选项/跳过建议）

示例（在 `code-rs/` 目录下）：

```bash
rustup run 1.90.0 cargo run -p code-utils-i18n-scan -- --include cli/src --limit 50
```

输出为 JSONL，字段包含 `file/literal/action/reason`：

- `action=i18n`：建议抽 key
- `action=review`：可能是路径/正则/代码片段，需要人工确认
- `action=skip`：更可能不应翻译（URL/flag/数字等）

## 5) 跟进上游更新（建议流程）

- 更新后先跑一次实际高频路径（或打开 TUI/跑 CLI），生成新的 `i18n-missing.jsonl`
- 用 `code-i18n-scan` 静态扫补盲区
- 增量补齐 `en.json/zh-CN.json`（英文作为 source-of-truth，避免顺手润色导致 diff 扩大）
- `./build-fast.sh` 必须零告警通过

