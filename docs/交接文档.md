# 交接文档（CODES）

## 仓库链路（上游 → 本仓）
- 上游 1：`https://github.com/openai/codex`
- 上游 2：`https://github.com/just-every/code`（fork 自 openai/codex，项目名 Every Code）
- 当前仓：`https://github.com/stevenwang288/codes`（基于 just-every/code 的再改造，目标产品名 CODES）

## 目标（面向用户的“独立产品”）
- 命令：`codes`（默认进入交互/TUI；非交互用 `codes exec ...`）
- 数据/配置目录：`~/.codes`（Windows：`C:\Users\<you>\.codes`）
- **不与 `~/.codex`、`~/.code` 共享状态/配置**（仅可能在开发构建缓存里看到 `.code` / `.codes-home`）
- UI/用户可见文案：不展示 `HOME` / `*_HOME` 字样（例如 `CODES_HOME`）

## 代码位置
- Rust 主代码：`code-rs/`（可修改）
- `codex-rs/`：上游镜像（只读，不改）
- Windows 全局安装脚本：`scripts/install-codes.ps1`
- macOS/Linux 安装脚本：`scripts/install-codes.sh`

## 必跑验证
- 必须从仓库根执行：`./build-fast.sh`
  - Windows 推荐用 Git for Windows 的 bash：`"C:/Program Files/Git/usr/bin/bash.exe" -lc "./build-fast.sh"`
  - 规则：0 errors + 0 warnings（把 warning 当失败处理）
  - 禁止：`rustfmt`

## 注入/自我认知（“CODES 知道自己在哪”）
- Prompt 组装：`code-rs/core/src/client_common.rs`
  - developer 指令块（模板）：`code-rs/core/prompt_coder.md`
  - user 指令块（AGENTS.md + skills 等）：`code-rs/core/src/project_doc.rs`
  - 环境上下文：`code-rs/core/src/environment_context.rs`（包含 `code_home/config_path/skills_root/system_skills_root/mcp_servers/...`）
- Session 初始化：`code-rs/core/src/codex/session.rs::build_initial_context`
  - 环境上下文支持 v2 “delta” 注入：避免每轮重复塞完整内容

## 目录体积说明（为什么几十 GB）
- `code-rs/target/`：Rust 构建产物（可能几十 GB）
- `.code/`、`.codes-home/`：本地构建缓存与中间产物（可清理，代价是下次重编译更慢）

