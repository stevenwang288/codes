# 交接文档（CODES/CODEX 项目）

## 基本信息
- 项目路径：`D:\OneDrive\steven\code\ai\12CLI\code-main`
- 项目仓库：`https://github.com/just-every/code`（fork 自 `https://github.com/openai/codex`）
- Rust 代码编辑位置：`code-rs/`（`codex-rs/` 为上游镜像只读）
- 必跑构建：`./build-fast.sh`（必须 0 警告；不要运行 rustfmt）
- 回复语言：全程简体中文
- 工作原则：定点修改，避免全量扫描导致卡顿

## 已完成的变更（仅基于代码修改，未运行验证）
### 1) 配置路径统一使用 CODEX
- `code-rs/core/src/config/sources.rs::find_code_home()` 仅支持 `CODEX_HOME` 或默认 `~/.codex`，不再回退旧路径。
- `resolve_code_path_for_read()` 继续只读 `code_home`。
- `code-rs/core/src/config.rs` 注释中的旧路径已改为 `~/.codex`。
- `code-rs/i18n/assets/en.json` 通知文案的配置路径已改为 `~/.codex/config.toml`。

### 1.5) 注入规则“单一来源”优先（避免被工作区 AGENTS 覆盖）
- `code-rs/core/src/project_doc.rs`：当 `config.user_instructions` 非空时，不再扫描/拼接工作区内的 `AGENTS.md`（避免“你说了规则但被项目里的 AGENTS 覆盖”）。
- 同样地，Auto Drive 的 `AUTO_AGENTS.md` 在 `user_instructions` 非空时也不再注入。

### 2) 路径“打开”功能默认禁用
- `code-rs/core/src/config.rs` 中默认 `file_opener` 设为 `UriBasedFileOpener::None`。

### 3) 设置导航与输入异常（代码层修复，待验证）
- `code-rs/tui/src/chatwidget/settings_handlers.rs`：
  - 菜单（子视图）激活时：`Left/Esc` 先退出菜单回到左侧列表（不再直接关闭整个设置页）。
  - 内容区：`Left` 回左侧列表；左侧列表：`Right/Enter` 进入内容。
- `code-rs/tui/src/bottom_pane/chat_composer.rs`：增强 ESC 序列处理（例如 `ESC [ Z` → BackTab，带数字修饰符序列继续等待，避免插入乱码）。

### 4) 主题列表数量（Windows 颜色模式）
- `code-rs/tui/src/theme.rs` 在 Windows 上强制 `Ansi256`，避免退回 `Ansi16` 只剩明暗两种主题。

### 5) 配置冲突判断
- `ConfigToml` 未见 `deny_unknown_fields`，因此 CODEX 读取包含 CODES 子代理字段的配置不会直接报错（未知字段会被忽略）。

## 未完成/待办清单（包含用户所有需求）
> 以下是用户明确要求但尚未完成的事项。

### A. 必须补齐的 i18n 残留
1) **中文 i18n 仍有旧路径残留（待处理，需改为 `~/.codex`）**
- 目标 key（在 `code-rs/i18n/assets/zh-CN.json`）：
  - `tui.notifications.custom_filters`
  - `tui.notifications.custom_hint`
- 现状：这两条仍可能含旧路径文案（需改为 `~/.codex/config.toml`）；文件内存在少量编码异常字符（显示为 `��`），做精确替换时要用“局部定位+小块替换”。

2) **设置菜单左侧列表（已补齐）+ 子/孙菜单英文残留（仍需 UI 对照确认）**
- 已补齐 key（`code-rs/i18n/assets/zh-CN.json`）：
  - `tui.settings.section.*`
  - `tui.settings.help.*`
  - `tui.settings.placeholder.*`
- 仍需：按截图逐项进入每个设置页的子/孙菜单，发现英文就补对应 key（避免全量扫描）。

3) **历史记录中的“已处理清单”需复核**
- 以下清单来自历史变更记录，需 UI 对照确认是否仍有英文残留：
  - `code-rs/tui/src/bottom_pane/login_accounts_view.rs`
  - `code-rs/tui/src/bottom_pane/agent_editor_view.rs`
  - `code-rs/tui/src/bottom_pane/github_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/agents_overview_view.rs`
  - `code-rs/tui/src/bottom_pane/update_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/prompts_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/auto_drive_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/review_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/planning_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/skills_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/mcp_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/notifications_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/account_switch_settings_view.rs`
  - `code-rs/tui/src/bottom_pane/theme_selection_view.rs`
  - `code-rs/tui/src/rate_limits_view.rs`
  - `code-rs/tui/src/bottom_pane/validation_settings_view.rs`

### B. 版本/更新/补丁流程（用户要求的总流程未做）
用户要求完整流程：
1) 与官方仓库比对版本号
2) 更新源码到当前路径
3) 编译代码
4) 应用国际化汉化（差异化补丁）
5) 应用所有补丁功能到当前代码

现状：未执行上述流程；只做了局部 i18n 与配置路径修改。
建议做法：
- 先确认当前项目与上游基线的版本号与差异（只做必要对比，避免全量扫描）。
- 再决定是否拉取更新/合并。

### C. 启动与验证
1) **必须运行 `./build-fast.sh`**（用户要求“直接编译正式版”）
- 目前未跑；必须在最终交付前运行且 0 警告。
2) **VT100 测试**
- 用户要求“vt100 你自己测试完全好了再汇报”；未执行。

### D. 配置与注入/自我认知
用户要求：
- 启动注入强制中文交互
- CODES 与 CODEX 共用同一套配置路径（全部指向 `CODEX_HOME`）
- 启动时能“自我认知”：知道所在路径、工具、技能、MCP、配置路径
- 不再频繁弹出 1/2/3 选择审批（减少批准流程）

现状：仅统一了 `CODEX_HOME` 默认路径；其他要求未实现或未验证。

### E. UI 交互与功能问题（部分已改，待验证）
1) **设置列表左键返回/导航丢失**（已改，待验证）
2) **主题列表数量变少**（已改 Windows 调色板模式，待验证）
3) **方向键/滚轮产生乱码并无法删除**（已增强 ESC 序列处理，待验证是否仍复现）
4) **路径“打开”功能异常**（已默认禁用，待确认是否仍有 UI 替换逻辑）
5) **提示语仍出现英文**（如“Ctrl+A 打开”等，需定位并 i18n）
6) **消息提醒/声音提醒**：用户要求增加，如无则开发。

### F. 子代理策略与监控机制
用户要求：
- 优先使用子代理减少主代理上下文污染
- 60 秒无增量就判定卡住并介入
- 避免并发过猛导致系统卡死

现状：未实现（需要在注入/调度逻辑中落地策略）。

### G. 其他问题
- “Rate limit reached” 弹窗原因与处理建议需说明
- “Auto Review: prompt-only actions validation regression” 提示需确认与处理（是否需合并修复分支）
- 绘话/对话记录路径统一到 `CODEX_HOME`（用户要求所有历史记录路径也统一）

## 建议的完成顺序（避免来回修改）
1) **先补齐中文 i18n 中旧路径残留**（改为 `~/.codex`，两条 key）
2) **完成用户指定的设置菜单英文清理**（如仍有遗漏，只按截图逐项定位）
3) **统一所有配置/记录路径为 `CODEX_HOME`**（含历史记录/日志/注入默认路径）
4) **复核 UI 交互问题**（左键返回、乱码、主题列表）
5) **确认路径“打开”功能已禁用并无 UI 残留**
6) **补充消息/声音提醒**
7) **实现子代理优先 + 60 秒无增量监控**
8) **最后统一编译 `./build-fast.sh` 并执行 VT100 测试**

## 关键定位参考（常用路径）
- 配置路径逻辑：`code-rs/core/src/config/sources.rs`
- 配置加载：`code-rs/core/src/config/builder.rs`, `code-rs/core/src/config_loader/mod.rs`
- i18n 资源：`code-rs/i18n/assets/en.json`, `code-rs/i18n/assets/zh-CN.json`
- 设置面板入口与渲染：`code-rs/tui/src/bottom_pane/`
- 设置键盘处理：`code-rs/tui/src/chatwidget/settings_handlers.rs`
- 输入框 ESC 序列：`code-rs/tui/src/bottom_pane/chat_composer.rs`
- 主题调色板：`code-rs/tui/src/theme.rs`

## 风险与注意事项
- 用户强烈要求：**不要全量扫描**、**不要频繁验证**、**避免并发过猛**。
- 本环境当前无法执行任何进程启动类操作（包括 `shell_command`/`apply_patch`），报错为 `windows sandbox: spawn setup refresh`；因此暂时无法运行 `./build-fast.sh` 或 VT100 测试，只能先完成代码改动。
- 一旦执行通道恢复，变更后必须跑 `./build-fast.sh`，且 0 警告。
- 不要动 `codex-rs/`。
