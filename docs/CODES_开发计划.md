# CODES 开发计划（长期执行版）

> 目标：把当前 fork 做成独立产品 **CODES**（命令 `codes`、数据目录 `~/.codes`），并用“补丁化/脚本化”方式可持续跟进上游更新。
>
> 本文件只解决两件事：**怎么做**（里程碑 + 验收）与 **怎么避免做着做着跑偏**（少提问 + 长时上下文策略）。

## 0) 产品硬约束（默认不再反复确认）

- 产品名：**CODES**
- 可执行：`codes`（CLI/TUI 均以此为入口）
- 配置/数据：`~/.codes`（Windows：`C:\Users\<you>\.codes`）
- **完全独立**：不与 `~/.codex`、`~/.code` 共享状态/配置
- UI 文案：用户界面中不出现 `*_HOME` / `HOME` 字样（例如 `CODES_HOME`）

> 若未来确实需要“兼容读取旧目录”，也只能作为 **一次性迁移**（导入后写回 `~/.codes`），而不是长期双写/共享。

## 1) 我们如何避免“问懒问题 / 问废话”

默认策略（不需要你额外指挥）：

1. **先读后问**：优先扫描 `docs/`、根 `README.md`、目录树与关键源码入口，再提问。
2. **只问不可逆分歧**：只有当存在“做 A 或做 B 都合理，但代价/影响不同”时才问；其余情况先选默认实现并落盘，随后给你可调整选项。
3. **不重复确认**：你已经说清楚的约束（例如“独立于 CODEX”）视为最终决定；实现时以测试/验收来确认，而不是反复问“是否确定”。
4. **把问题变成可验收条目**：需求落到 `docs/CODES_TODO.md` 的“可验收描述 + 最小实现 + 风险/替代方案”，避免“记录了但落不了地”。

## 2) 长时间开发不丢上下文（5–10 小时甚至更久）

现实约束：模型上下文是有限的；要想“长时间持续推进”，必须把关键状态写到仓库里。

执行策略（我们会按此运行）：

- **单一需求源**：所有需求与优先级只看 `docs/CODES_TODO.md`。
- **阶段性交付**：每完成一个可交付单元，就把“做了什么/怎么验收/遗留风险”写回 `docs/CODES_TODO.md` 的“已完成（Patch 记录）”。
- **交接最小化**：`docs/交接文档.md` 只记录“仓库链路 + 构建/安装 + 注入链路定位 + 当前状态”；不堆叠细节。
- **自动化护栏**：把“质量卫兵/后台巡检/通知”做成可开关机制，避免阻塞主开发流（详见里程碑 M3/M4）。

## 3) 里程碑（按优先级推进）

### M0：文档与命名清理（CODES 一致性）
- 目标：你打开 README/文档就能直接按 CODES 方式使用，不被 `Code/Codex/WSL2` 等历史信息误导。
- 验收：
  - CODES 的权威入口清晰：`README.md` + `docs/index.md`。
  - “已完成/已推翻”的需求有明确归档，不再混杂在同一段落里。
  - 新增需求（通知/语音/少提问）进入 `docs/CODES_TODO.md`，且带验收标准。

### M1：TUI 交互一致性（Esc 逐级返回）
- 目标：所有 overlay / 面板 / picker / bottom pane 的 `Esc` 行为统一为“只退一级，直到回到聊天界面为止”。
- 验收：
  - 关键入口都有回归测试覆盖（至少覆盖 `/settings` 与一个典型 picker）。

### M2：最高权限/最丝滑模式（减少阻塞）
- 目标：用户明确选择“最高权限”后，尽量不被审批/确认/guard 打断长任务。
- 验收：
  - “最高权限”是一个可一键应用的 preset（计划放入 `/settings` 与 `Ctrl+L`）。
  - 解释清楚“为何你以为给了最高权限仍会卡住”的真正来源，并可配置关闭（例如 `confirm_guard`）。

### M3：多标签/后台友好（通知 + 声音 + 卡住提醒）
- 目标：你切到别的 tab 也不会错过“需要你介入”的时刻。
- 验收：
  - 至少支持：回合完成、需要审批/输入、可能卡住（长时间无进度）。
  - “无增量卡住”覆盖主流程与子代理（同一套判据与阈值配置）。
  - 跨平台策略明确（Windows/macOS/Linux），并提供“无外部依赖”的降级方案。

### M4：质量卫兵（Auto Review / 不阻塞主线程）
- 目标：主流程“快写快跑”，质量检查在后台持续进行，集中反馈可执行修复。
- 验收：
  - 后台审计不会修改主工作区；输出可直接应用（patch/建议），由你决定是否落地。
  - 可配置：Fast/Balanced/Strict 三档，避免开发被频繁检查拖慢。
  - 关键错误/失败会沉淀为“质量档案”（落盘诊断记录），避免反复踩坑。

### M5：分发与安装（跨平台）
- 目标：任意目录执行 `codes` 即可启动（CLI/TUI），并能“在线安装”（NPM 或 Release 安装器）。
- 验收：
  - Windows/macOS/Linux 都有清晰的安装路径与回滚方法。
  - NPM 形式（`npx`/`npm i -g`）有可行技术路线与最小可用实现。

### M6：语音输入（可选，后置）
- 目标：在 TUI/CLI 内一键语音转文字，并可选二次“纠错润色”。
- 验收：
  - 可配置：在线（云 API）/离线（本地 Whisper）二选一。
  - 默认关闭，不影响核心使用与隐私预期。

## 4) 需要你“只确认一次”的两个点（不回就按默认）

1) **通知触发**默认开三类：`turn complete`、`approval/input requested`、`stall detected`。  
2) **语音输入路线**默认先做在线（云 API）版本，离线作为后续增强。  
